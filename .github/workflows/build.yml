name: Build & Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build for'
        required: true
        default: 'windows'
        type: choice
        options:
        - windows

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Godot
      run: |
        Invoke-WebRequest -Uri "https://downloads.tuxfamily.org/godotengine/4.4/Godot_v4.4-stable_win64.exe.zip" -OutFile "godot.zip"
        Expand-Archive -Path "godot.zip" -DestinationPath "godot"
        $env:PATH += ";$PWD/godot"
        echo "$PWD/godot" >> $env:GITHUB_PATH
        
    - name: Create export presets
      run: |
        mkdir -p .godot/export_presets.cfg
        @"
        [preset.0]
        name="Windows Desktop"
        platform="Windows Desktop"
        runnable=true
        export_path="build/windows/aarpg.exe"
        [preset.1]
        name="Windows Desktop (Debug)"
        platform="Windows Desktop"
        runnable=true
        export_path="build/windows/aarpg_debug.exe"
        debug=true
        "@ | Out-File -FilePath .godot/export_presets.cfg -Encoding utf8
        
    - name: Export Windows Debug
      run: |
        mkdir -p build/windows
        godot --headless --export-debug "Windows Desktop" build/windows/aarpg_debug.exe
        
    - name: Export Windows Release
      run: |
        godot --headless --export-release "Windows Desktop" build/windows/aarpg.exe
        
    - name: Create Windows Archive
      run: |
        cd build/windows
        Compress-Archive -Path * -DestinationPath aarpg-windows.zip
        
    - name: Upload Windows Build
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows/

  create-release:
    name: Create Release
    runs-on: windows-latest
    needs: [build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Windows Build
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: windows-build/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Pantheos 4C - ${{ github.ref_name }}
          
          ### Downloads
          - **Windows**: `aarpg-windows.zip`
          
          ### Changes
          See commit history for detailed changes.
          
          ### Installation
          1. Download the Windows build
          2. Extract the archive
          3. Run aarpg.exe
        files: |
          windows-build/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}